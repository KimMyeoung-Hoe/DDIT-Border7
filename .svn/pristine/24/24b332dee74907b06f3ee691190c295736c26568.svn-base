<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ë¯¼ì›ì‚¬í•­ ê²Œì‹œíŒ</title>
<%@ include file="../modules/header.jsp" %>
<%@ include file="../modules/sidebar.jsp" %>
<link rel="stylesheet" href="/css/main.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<sec:authentication property="principal" var="princ"/>
<c:set value="${princ.user }" var="userVO"></c:set>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"/>

<style>
.appeal-answer-row {
    display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    background-color: #f9f9f9; /* ë‹µë³€ ì˜ì—­ ë°°ê²½ìƒ‰ */
    border-top: 1px solid #ddd;
}
.appeal-answer-content {
    padding: 15px;
}
.appeal-answer-file-list {
    margin-top: 10px;
    font-size: 0.9em;
    color: #555;
}
.appeal-answer-file-list a {
    display: block; /* íŒŒì¼ ëª©ë¡ì„ ë¸”ë¡ ë ˆë²¨ë¡œ í‘œì‹œ */
    margin-bottom: 5px;
}
/* í´ë¦­ ê°€ëŠ¥í•œ ì œëª©ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì»¤ì„œ ë³€ê²½ */
.appeal-title-link {
    cursor: pointer;
    text-decoration: none; /* ê¸°ë³¸ ë°‘ì¤„ ì œê±° */
    color: #007bff; /* ë§í¬ ìƒ‰ìƒ */
}
.appeal-title-link:hover {
    text-decoration: underline; /* í˜¸ë²„ ì‹œ ë°‘ì¤„ */
}
/* ë‹µë³€ ì—†ëŠ” ì œëª© í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
.appeal-title-text {
    color: #333; /* ì¼ë°˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    cursor: default; /* ê¸°ë³¸ ì»¤ì„œ ëª¨ì–‘ */
}

/* ì¶”ê°€ëœ CSS: ë‚´ìš© ìë¥´ê¸° ë° ë”ë³´ê¸° ë²„íŠ¼ ê´€ë ¨ */
.appeal-content-cell {
    max-width: 250px; /* ë‚´ìš© ì»¬ëŸ¼ì˜ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
    white-space: normal; /* ê¸°ë³¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
    word-wrap: break-word; /* ê¸´ ë‹¨ì–´ ê°•ì œ ì¤„ë°”ê¿ˆ */
}
.full-content {
    display: none; /* ì´ˆê¸°ì—ëŠ” ì „ì²´ ë‚´ìš© ìˆ¨ê¹€ */
}
.toggle-content-btn {
    display: inline-block; /* ë²„íŠ¼ í˜•íƒœë¡œ í‘œì‹œ */
    margin-left: 5px;
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
    font-size: 0.9em;
}
.toggle-content-btn:hover {
    color: #0056b3;
}
</style>

</head>
<body>

<div class="app-container">
    <main class="main-content-area">
        <div class="content-header">
           <div class="breadcrumb-warp">
              <div class="col-sm-12">
                 <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/board/appealList.do">ë¯¼ì›</a></li>
                 </ol>
              </div>
           </div>
        <div class="content-title">ë¯¼ì›</div>
           <p class="desc" style="font-size: small;"> <br/>ê° ë¯¼ì› ì œëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™ë©ë‹ˆë‹¤</p>
        </div>
        <div class="section">
            <div class="support-tabs">
                <div class="tab-item " data-tab="notice">
                    <i class="fas fa-bullhorn tab-icon"></i><span id="goNoticeBtn"> ê³µì§€ì‚¬í•­</span>
                </div>
                <div class="tab-item" data-tab="faq">
                    <i class="fas fa-question-circle tab-icon"></i><span id="goFaqBtn">ìì£¼ ì°¾ëŠ” ì§ˆë¬¸ (FAQ)</span> 
                </div>
                <div class="tab-item active" data-tab="appeal">
                    <i class="fas fa-bullhorn tab-icon"></i> <span id="goAppeal">ë¯¼ì›</span>
                </div>
            </div>    
        
            <div class="search-filter-section">
                <div class="filter-group">
                    <select class="form-select" id="searchType" >
                      <option>
                         ê²€ìƒ‰ íƒ€ì…ì„ íƒ
                     </option>
                     <option value="APPEAL_TITLE" <c:if test="${searchType == 'APPEAL_TITLE'}">selected</c:if>>
                        ë¯¼ì› ì œëª©
                     </option>
                     <option value="APPEAL_TYPE" <c:if test="${searchType == 'APPEAL_TYPE'}">selected</c:if>>
                        ë¯¼ì› ë¶„ë¥˜
                     </option>
                  </select>
                </div>
               <div class="search-input-wrapper">
                  <div class="search-input-icon"></div>
                  <input type="text" class="form-input search-input" value="${searchWord }" placeholder="ì œëª©,ë¶„ë¥˜ ê²€ìƒ‰">
               </div>
               <div class="filter-group">
                  
                  <select class="form-select" id="sortColumn1">
                     <option>
                         ìˆœì„œ ì •ë ¬
                     </option> 
                     <option value="APPEAL_REG_DATE" <c:if test="${fn:startsWith(sortColumn, 'APPEAL_REG_DATE')}">selected</c:if>>
                        ë¯¼ì› ì‘ì„± ì¼ì‹œ
                     </option>
                     <option value="APPEAL_ANSWER" <c:if test="${fn:startsWith(sortColumn, 'APPEAL_ANSWER')}">selected</c:if>>
                        ë‹µë³€ ì—¬ë¶€
                     </option>
                  </select>
                  <select class="form-select" id="sortColumn2">
                     <option>
                         ì •ë ¬ ë°©í–¥
                     </option>
                     <option value="DESC" <c:if test="${fn:endsWith(sortColumn, 'DESC')}">selected</c:if>>
                        ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                     </option>
                     <option value="ASC" <c:if test="${fn:endsWith(sortColumn, 'ASC')}">selected</c:if>>
                        ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                     </option>
                  </select>
                  <button class="btn btn-primary" id="searchBtn">ê²€ìƒ‰</button>
               </div>
            </div>

            <div class="table-section">
                <table class="data-table">
                <thead>
                    <tr>
                        <th>ë²ˆí˜¸</th>
                        <th>ë¯¼ì› ì œëª©</th>
                        <th>ë¯¼ì› ë¶„ë¥˜</th>
                        <th>ë¯¼ì› ë‚´ìš©</th>
                        <th>ë¯¼ì› ì‘ì„±ì¼ì‹œ</th>
                        <th>ë‹µë³€ ì—¬ë¶€</th>
                        <th>ë‚´ ì²¨ë¶€íŒŒì¼ ì—¬ë¶€</th>
                        <c:choose>
                        	<c:when test="">
                        		 <th>ì‚­ì œ</th>
                        	</c:when>
                        	<c:otherwise>
                        		<th>ë‹µë³€</th>
                        	</c:otherwise>
                        </c:choose>
                    </tr>
                </thead>
                <tbody>
                    <c:if test="${empty appealList}">
                    <tr>
                        <td colspan="7" style="text-align: center;">ë¯¼ì› ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </c:if>
                    <c:if test="${not empty appealList }">
                        <c:forEach items="${appealList }" var="appeal" varStatus="vs">
                            <tr class="appeal-row" data-appeal-no="${appeal.appealNo}">
                                <td>${vs.count }</td>
								<td>
								    <c:if test="${not empty appeal.appealAnswer}">
								        <a href="#" class="appeal-title-link" data-appeal-no="${appeal.appealNo}">
								            ${appeal.appealTitle}
								        </a>
								    </c:if>
								    <c:if test="${empty appeal.appealAnswer}">
								        <span class="appeal-title-text">${appeal.appealTitle}</span>
								    </c:if>
								</td>
                                <td>${appeal.appealType }</td>
                                <td class="appeal-content-cell">
                                    <c:set var="maxLength" value="20" />
                                    <c:set var="contentLength" value="${fn:length(appeal.appealContent)}" />
                                    
                                    <c:if test="${contentLength > maxLength}">
                                        <span class="truncated-content">${fn:substring(appeal.appealContent, 0, maxLength)}...</span>
                                        <span class="full-content" style="display:none;">${appeal.appealContent}</span>
                                        <a href="#" class="toggle-content-btn" data-state="truncated">ë”ë³´ê¸°</a>
                                    </c:if>
                                    <c:if test="${contentLength <= maxLength}">
                                        <span>${appeal.appealContent}</span>
                                    </c:if>
                                </td>
                                <td>${appeal.appealRegDate }</td>
                                <td>
                                    <c:if test="${empty appeal.appealAnswer }">
                                        ì—†ìŒ
                                    </c:if>
                                    <c:if test="${not empty appeal.appealAnswer }">
                                        ìˆìŒ
                                    </c:if>
                                </td>
                                <td>
                                	<c:if test="${appeal.appealAttch != 0 }">
                                		<a href="#" id="fileDetail">ìˆìŒ</a>
										<c:forEach items="${appeal.appealFileList}" var="appealFile" varStatus="status">
										  	<div class="fileData" data-file-list="${appealFile}"></div>
										</c:forEach>
                                	</c:if>
                                    <c:if test="${appeal.appealAttch == 0 }">
                                        ì—†ìŒ
                                    </c:if>
                                </td>
                                <td>
                                <c:choose>
		                        	<c:when test="${fn:startsWith(userVO.authCode,'ROLE_SVT') && appeal.appealAttch == 0}">
		                        		 <button class="btn btn-primary" id="appealAnswerBtn_${vs.index}" data-appeal-no="${appeal.appealNo}">ë¯¼ì› ë‹µë³€í•˜ê¸°</button>
		                        	</c:when>
		                        	<c:otherwise>
		                        		<c:if test="${empty appeal.appealAnswer}">
                                		<button class="btn btn-secondary delete-appeal-btn" data-appeal-no="${appeal.appealNo}">ë¯¼ì› ì‚­ì œí•˜ê¸°</button> <%-- IDê°€ ì•„ë‹Œ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. --%>
                                	</c:if>
                                	<c:if test="${not empty appeal.appealAnswer}">
                                		<span>ì‚­ì œë¶ˆê°€</span>
                                	</c:if>
		                        	</c:otherwise>
		                        </c:choose>
                                </td>
                            </tr>
                            <tr class="appeal-answer-row" id="answer-row-${appeal.appealNo}">
                                <td colspan="1">${vs.count }</td>
                                <td colspan="1"><strong>[ë‹µë³€]</strong></td>
                                <td colspan="6">
                                
                                    <div class="appeal-answer-content"">
                                        <c:if test="${not empty appeal.appealAnswer }">
                                        	<c:if test="${not empty appeal.answerFileList}">
                                                <div class="appeal-answer-file-list">
                                                    <strong>ì²¨ë¶€ ë‹µë³€ íŒŒì¼:</strong><br/>
                                                    <c:forEach items="${appeal.answerFileList }" var="answerFile">
                                                        <a href="/upload/appeal_answer/${answerFile.comFileDetailSaveName}" download>${answerFile.comFileDetailOriginalName }</a>
                                                    </c:forEach>
                                                </div>
                                            </c:if>
                                        	<div style="display: flex; justify-content: space-between; align-items: center;">
											    ${appeal.appealAnswer } 
											    <small>ë‹µë³€ì¼: <fmt:formatDate value="${appeal.appealAnswerDate}" pattern="yyyy-MM-dd HH:mm"/></small>
											</div>
                                        </c:if>
                                        <c:if test="${empty appeal.appealAnswer }">
                                            <p>ì•„ì§ ë‹µë³€ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                                        </c:if>
                                    </div>
                                    
                                </td>
                            </tr>
                        </c:forEach>
                    </c:if>
                </tbody>
            </table>
            </div>
            <div class="table-footer">
                    <div class="d-flex justify-content-center mt-4">
                        <ul class="pagination">
                            <c:if test="${paginationInfo.startPage > 1}">
                                <li class="page-item">
                                    <a class="page-link page-link-text" href="#" data-page="${paginationInfo.startPage - paginationInfo.blockSize}">ì´ì „</a>
                                </li>
                            </c:if>
                        
                            <c:forEach var="i" begin="${paginationInfo.startPage}" end="${paginationInfo.endPage < paginationInfo.totalPage ? paginationInfo.endPage : paginationInfo.totalPage}">
                                <li class="page-item ${i == paginationInfo.currentPage ? 'active' : ''}">
                                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                                </li>
                            </c:forEach>
                        
                            <c:if test="${paginationInfo.endPage < paginationInfo.totalPage}">
                                <li class="page-item">
                                    <a class="page-link page-link-text" href="#" data-page="${paginationInfo.endPage + 1}">ë‹¤ìŒ</a>
                                </li>
                            </c:if>
                        </ul>
                    </div>
                    
                    <c:if test="${not fn:startsWith(userVO.authCode,'ROLE_SVT')}">
                        <div class="header-action-buttons">
                            <button class="action-button primary small-button" id="addBtn">ìƒˆ ë¯¼ì› ë“±ë¡</button>
                        </div>
                    </c:if>
                </div>
            </div>
        </main>
    </div>
    
<div class="modal fade" id="appealModal" tabindex="-1" aria-labelledby="appealModalLabel" >
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appealModalLabel">ë¯¼ì›ì‚¬í•­ ë“±ë¡</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <form id="appealForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="appealTitle" class="form-label">ì œëª©</label>
            <input type="text" class="form-control" id="appealTitle" name="appealTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
          </div>

          <div class="mb-3">
            <label for="appealType" class="form-label">ë¯¼ì› ì¢…ë¥˜</label>
            <select class="form-select" id="appealType" name="appealType" required>
              <option value="">ì¢…ë¥˜ ì„ íƒ</option>
              <option value="ë¶ˆí¸ì‚¬í•­">ë¶ˆí¸ì‚¬í•­</option>
              <option value="ê±´ì˜ì‚¬í•­">ê±´ì˜ì‚¬í•­</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="appealContent" class="form-label">ë‚´ìš©</label>
            <textarea class="form-control" id="appealContent" name="appealContent" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="appealContent" class="form-label">ê´€ì„¸ëŒ€ë¦¬ì—…ë¬´ ê³„ì•½ë²ˆí˜¸</label>
            <input type="text" class="form-control" id="declno" name="declno" placeholder="ë§Œì•½ ì—…ë¬´ê´€ë ¨ì´ë¼ë©´ ì‘ì„±í•´ì£¼ì„¸ìš”">
          </div>

          <div class="mb-3">
            <label for="appealFile" class="form-label">ì²¨ë¶€íŒŒì¼</label>
            <input class="form-control" type="file" id="appealFiles" name="appealFiles" multiple="multiple">
            <div id="selectedFilesDisplay" class="mt-2 text-muted small"></div>
          </div>
          <div>
            
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="submitAppealBtn">ë“±ë¡</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ë‹µë³€ ëª¨ë‹¬ ì‹œì‘ -->
<div class="modal fade" id="answerModal" tabindex="-1" aria-labelledby="answerModalLabel" >
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="appealModalLabel">ë¯¼ì› ë‹µë³€ ë“±ë¡</h5>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label for="appealTitle" class="form-label">ì œëª©</label>
					<input type="text" id="modalAppealTitle" class="form-control" readonly>
				</div>
				<div class="mb-3">
					<label for="appealType" class="form-label">ë¯¼ì› ì¢…ë¥˜</label>
					<input type="text" id="modalAppealType" class="form-control" readonly>
				</div>
				<div class="mb-3">
					<label for="appealContent" class="form-label">ë‚´ìš©</label>
					<textarea id="modalAppealContent" class="form-control" readonly></textarea>
				</div>
			</div>
			<div class="modal-body">
				<div class="mb-3">
				  <label for="appealTitle" class="form-label">ë‹µë³€</label>
				  <textarea id="appealAnswer" rows="10" cols="51" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”">
				  </textarea>
				</div>
			</div>
			<div class="mb-3">
				<label for="appealFile" class="form-label">ì²¨ë¶€íŒŒì¼</label>
				<input class="form-control" type="file" id="appealAnswerFiles" name="appealAnswerFiles" multiple="multiple">
				<div id="selectedAnswerFilesDisplay" class="mt-2 text-muted small">
				
				</div>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-primary" id="submitAppealAnserBtn">ë“±ë¡</button>
			</div>
		</div>
	</div>
</div>
<!-- ë‹µë³€ ëª¨ë‹¬ ë -->
<!-- ì²¨ë¶€íŒŒì¼ ëª¨ë‹¬ ì‹œì‘ -->
<div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" >
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="fileModalLabel">ì²¨ë¶€íŒŒì¼</h5>
			</div>
			<div class="modal-body" id="fileModalBody">

			</div>
		</div>
	</div>
</div>
<!-- ì²¨ë¶€íŒŒì¼ ëª¨ë‹¬ ë -->
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

<script type="text/javascript">
$(function(){
    // AlertifyJS ê¸°ë³¸ ì„¤ì • (ì˜µì…˜)
    alertify.defaults.glossary.title = 'ì•Œë¦¼';
    alertify.defaults.glossary.ok = 'í™•ì¸';
    alertify.defaults.glossary.cancel = 'ì·¨ì†Œ';
    alertify.defaults.notifier.delay = 3; // ì•Œë¦¼ ìœ ì§€ ì‹œê°„ (ì´ˆ)
    alertify.defaults.closable = true; // ë‹«ê¸° ë²„íŠ¼ í‘œì‹œ

    var goFaqBtn = $("#goFaqBtn");
    var goNoticeBtn = $("#goNoticeBtn");
    var goAppeal = $("#goAppeal");
    var addBtn = $("#addBtn");
    var submitAppealBtn = $('#submitAppealBtn');
    var appealFilesInput = $('#appealFiles');
    var appealAnswerFiles = $('#appealAnswerFiles');
    var selectedFilesDisplay = $('#selectedFilesDisplay');
    // deleteBtnì€ ì—¬ëŸ¬ ê°œ ì¡´ì¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, IDê°€ ì•„ë‹Œ í´ë˜ìŠ¤ ì…€ë ‰í„°ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    // var deleteBtn = $("#deleteBtn");  // ì´ ë¶€ë¶„ì€ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
    var selectedAnswerFilesDisplay = $('#selectedAnswerFilesDisplay');

    goNoticeBtn.on("click",function(){
        window.location.href="/board/noticeList.do";
    });
    goFaqBtn.on("click",function(){
        window.location.href="/board/faqList.do";
    });
//--------------------------------------------------------------------------
// ë¯¼ì› ë‹µë³€ ëª¨ë‹¬ ì¶œë ¥ ì´ë²¤íŠ¸
$("[id^='appealAnswerBtn']").on('click', function() {
    let appealNo = $(this).data("appealNo");
    let thisRow = $(this).closest("tr");
    
    // appealNo ê°’ ì €ì¥
    $("#submitAppealAnserBtn").data("appealNo", appealNo);
    // ê° ì…€ì—ì„œ í•„ìš”í•œ ê°’ ì¶”ì¶œ
    let appealTitle = thisRow.find(".appeal-title-link, .appeal-title-text").text().trim();
    let appealType = thisRow.find("td").eq(2).text().trim();
    let appealContent = thisRow.find(".full-content").text().trim() || thisRow.find(".truncated-content").text().trim();

    // ëª¨ë‹¬ input ìš”ì†Œì— ê°’ ì„¸íŒ…
    $("#modalAppealTitle").val(appealTitle);
    $("#modalAppealType").val(appealType);
    $("#modalAppealContent").val(appealContent.replace("...", ""));

    // ëª¨ë‹¬ ì—´ê¸°
    let answerModal = new bootstrap.Modal(document.getElementById('answerModal'));
    answerModal.show();
    
});
	//--------------------------------------------------------------------------
	// ë¯¼ì› ë‹µë³€ ë“±ë¡ ì´ë²¤íŠ¸
	$("#submitAppealAnserBtn").on('click',function() {
		// FormData ê°ì²´ ìƒì„±
    	const formData = new FormData();

    	// textarea ê°’ ì¶”ê°€
    	const answerText = $("#appealAnswer").val().trim();
    	formData.append("appealAnswer", answerText);

    	// ì²¨ë¶€ëœ íŒŒì¼ë“¤ ì¶”ê°€
    	const files = $("#appealAnswerFiles")[0].files;
    	for (let i = 0; i < files.length; i++) {
       	 formData.append("appealAnswerFiles", files[i]);
    	}  
		const appealNo = $("#submitAppealAnserBtn").data("appealNo");
		formData.append("appealNo", appealNo);

		$.ajax({
			url : "<%=request.getContextPath()%>/board/answerAppeal.do",
			type: "POST",
        	data: formData,
        	processData: false,
        	contentType: false,
			success : function (res) {
            	if (res > 0) {
                	location.reload();
            	} 
        	},
        	error: function (xhr, status, error) {
            	console.error("ë“±ë¡ ì‹¤íŒ¨ ì˜¤ë¥˜:", error);
            	alert("ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
       		}
    	});
	})
//--------------------------------------------------------------------------
//ìƒˆë¯¼ì›ë“±ë¡ë²„íŠ¼ ì´ë²¤íŠ¸
    addBtn.on("click",function(){
        $('#appealForm')[0].reset();
        selectedFilesDisplay.empty();
        $("#appealModal").modal("show");
    });
//--------------------------------------------------------------------------
// íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
    appealFilesInput.on('change', function() {
        selectedFilesDisplay.empty(); 
        var files = this.files;
        if (files.length > 0) {
            for (var i = 0; i < files.length; i++) {
                selectedFilesDisplay.append('<div class="file-name">' + files[i].name + '</div>');
            }
        } else {
            selectedFilesDisplay.append('<div>ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>');
        }
    });
//--------------------------------------------------------------------------
// ë‹µë³€ ì‹œ íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
    appealAnswerFiles.on('change', function() {
    	selectedAnswerFilesDisplay.empty(); 
        var files = this.files;
        if (files.length > 0) {
            for (var i = 0; i < files.length; i++) {
            	selectedAnswerFilesDisplay.append('<div class="file-name">' + files[i].name + '</div>');
            }
        } else {
        	selectedAnswerFilesDisplay.append('<div>ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>');
        }
    });
    
//--------------------------------------------------------------------------    
// ë“±ë¡ë²„íŠ¼ ì´ë²¤íŠ¸ (jQuery Confirm ì ìš©)
	submitAppealBtn.on('click', function () {
	    // íŒŒì¼ ì…ë ¥ í•„ë“œ ì²˜ë¦¬ (ë¹ˆ íŒŒì¼ í•„ë“œ ì œê±°)
	    document.querySelectorAll('input[type="file"]').forEach(input => {
	        if (!input.files || input.files.length === 0 || input.files[0].size === 0) {
	            input.remove();
	        }
	    });
	
	    $.confirm({
	        title: 'ë¯¼ì› ë“±ë¡ í™•ì¸',
	        content: 'ë¯¼ì›ì‚¬í•­ì€ í•œ ë²ˆ ë“±ë¡í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
	        buttons: {
	            confirm: {
	                text: 'ë“±ë¡í•˜ê¸°',
	                btnClass: 'btn-primary',
	                action: function () {
	                    const form = $('#appealForm')[0];
	                    const formData = new FormData(form);
	                    const userNo = `${userVO.userNo}`;
	                    formData.append("userNo", userNo);
	
	                    $.ajax({
	                        url: "<%=request.getContextPath()%>/board/registAppeal.do",
	                        type: "POST",
	                        data: formData,
	                        processData: false,
	                        contentType: false,
	                        dataType: "text",
	                        success: function (cnt) {
	                            if (cnt > 0) {
	                                alertify.success("ë¯¼ì› ë“±ë¡ ì„±ê³µ!"); // AlertifyJS success
	                                $('#appealModal').modal('hide'); // ëª¨ë‹¬ ë‹«ê¸°
	                                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
	                            } else {
	                                alertify.error("ë¯¼ì› ë“±ë¡ ì‹¤íŒ¨!"); // AlertifyJS error
	                            }
	                        },
	                        error: function (xhr, status, error) {
	                            console.error("ë“±ë¡ ì‹¤íŒ¨ ì˜¤ë¥˜:", error);
	                            alertify.error("ë¯¼ì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); // AlertifyJS error
	                        }
	                    });
	                }
	            },
	            cancel: {
	                text: 'ì·¨ì†Œ',
	                btnClass: 'btn-danger',
	                action: function () {
	                    alertify.error('ë¯¼ì› ì‘ì„±ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.'); // AlertifyJS error
	                }
	            }
	        }
	    });
	});

//--------------------------------------------------------------------------
// ë¯¼ì› ì œëª© í´ë¦­ ì‹œ ì•„ì½”ë””ì–¸ í† ê¸€ ì´ë²¤íŠ¸
    $(document).on("click", ".appeal-title-link", function(e){
        e.preventDefault(); 

        var appealNo = $(this).data("appeal-no"); 
        var $answerRow = $("#answer-row-" + appealNo); 
        
        $(".appeal-answer-row").not($answerRow).slideUp(); 
        $answerRow.slideToggle("fast");
    });
    
//--------------------------------------------------------------------------
// ë¯¼ì› ë‚´ìš© "ë”ë³´ê¸°/ê°„ëµíˆ" í† ê¸€ ì´ë²¤íŠ¸
    $(document).on("click", ".toggle-content-btn", function(e){
        e.preventDefault();
        var $cell = $(this).closest('.appeal-content-cell');
        var $truncated = $cell.find('.truncated-content');
        var $full = $cell.find('.full-content');
        var $btn = $(this);

        if ($btn.data('state') === 'truncated') {
            $truncated.hide();
            $full.show();
            $btn.text('ê°„ëµíˆ');
            $btn.data('state', 'full');
        } else {
            $full.hide();
            $truncated.show();
            $btn.text('ë”ë³´ê¸°');
            $btn.data('state', 'truncated');
        }
    });
//------------------------------------------------------------
// ì‚­ì œë²„íŠ¼ í´ë¦­ì´ë²¤íŠ¸ (class ì…€ë ‰í„° ì‚¬ìš© ë° data-appeal-no í™œìš©)
	$(document).on("click", ".delete-appeal-btn", function(){ // IDê°€ ì•„ë‹Œ í´ë˜ìŠ¤ ì…€ë ‰í„°ë¥¼ ì‚¬ìš©í•˜ê³ , ë™ì  ìš”ì†Œì—ë„ ì ìš©ë˜ë„ë¡ documentì— ë°”ì¸ë”©
		var appealNo = $(this).data("appealNo"); // í´ë¦­ëœ ë²„íŠ¼ì˜ data-appeal-no ê°€ì ¸ì˜¤ê¸°
		
		$.confirm({
			title: 'ì‚­ì œ í™•ì¸',
			content: 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
			buttons: {
				confirm: {
					text: 'ì‚­ì œí•˜ê¸°',
					btnClass: 'btn-danger',
					action: function () {
						$.ajax({
							url: "<%=request.getContextPath()%>/board/deleteAppeal.do",
							type: "POST",
							data: {
								appealNo : appealNo // ê°€ì ¸ì˜¨ appealNo ì‚¬ìš©
							},
							dataType: "text",
							success: function (cnt) {
								if (cnt > 0) {
									alertify.success("ë¯¼ì› ì‚­ì œ ì„±ê³µ!"); // AlertifyJS success
									location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
								} else {
									alertify.error("ë¯¼ì› ì‚­ì œ ì‹¤íŒ¨!"); // AlertifyJS error
								}
							},
							error: function (xhr, status, error) {
								console.error("ì‚­ì œ ì‹¤íŒ¨ ì˜¤ë¥˜:", error);
								alertify.error("ë¯¼ì› ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); // AlertifyJS error
							}
						});
					}
				},
				cancel: {
					text: 'ì·¨ì†Œ',
					btnClass: 'btn-primary',
					action: function () {
						alertify.error('ë¯¼ì› ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.'); // AlertifyJS error
					}
				}
			}
		});
	});
//------------------------------------------------------------------------------------
// íŒŒì¼ìƒì„¸ë³´ê¸° ëª¨ë‹¬
	$("#fileDetail").on("click", function (e) {
		  e.preventDefault();

		  const fileElements = document.querySelectorAll(".fileData");
		  const files = [];

		  fileElements.forEach(el => {
		    const raw = el.dataset.fileList;

		    // ê°ì²´ ë¬¸ìì—´ì—ì„œ ê°’ ì¶”ì¶œ
		    const name = raw.match(/comFileDetailOriginalName=([^,]+)/)?.[1]?.trim();
		    const path = raw.match(/comFileDetailSavePath=([^,]+)/)?.[1]?.trim();

		    if (name && path) {
		      files.push({ name, path });
		    }
		  });
			
		// ëª¨ë‹¬ì— ì¶œë ¥
		  let html = '';
			if (files.length > 0) {
			  files.forEach((file, idx) => {
			    const encodedPath = file.path;
			    console.log("encodedPath",encodedPath);
			    console.log("file",file);
			    html += `
			      <div class="mb-3">
			        <label class="form-label">ğŸ“ \${idx + 1}. \${file.name}</label>
			        <a href="/${encodedPath}" class="btn btn-sm btn-primary">ë‹¤ìš´ë¡œë“œ</a>
			      </div>
			    `;
			  });
			} else {
			  html = '<p>ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
			}


		  
		  $("#fileModalBody").html(html);
		  $("#fileModal").modal("show");
		});

});
</script>
</html>