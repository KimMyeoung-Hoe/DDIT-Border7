<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒì„¸ ì˜ë¢°í˜„í™©</title>
<%@ include file="../modules/header.jsp" %>
<%@ include file="../modules/sidebar.jsp" %>
<%@ include file="../modules/modal.jsp" %>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="/css/main.css">
<script type="text/javascript" src="https://map.vworld.kr/js/webglMapInit.js.do?version=3.0&apiKey=B8521EDE-A4E1-33B0-8029-530100FD4344"></script>
<style>
/* .info-row:has(.card-title) + .info-row{
	border-top:none;
}
.info-row + .info-row {
    border-top: 1px solid #000000;
}
.info-row {
    display: flex;
    align-items: flex-start;
    margin: 0;
    padding: 10px;
}
 */
</style>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
	<div class="app-container">
		<main class="main-content-area">
			<div class="content-header">
				<!-- ë¸Œë ˆë“œí¬ëŸ¼ ì—˜ë¦¬ë¨¼íŠ¸ -->
				<div class="breadcrumb-warp">
					<div class="col-sm-12">
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="/">Home</a></li>
							<li class="breadcrumb-item"><a href="/consignor/myContract.do">ë‚´ ì˜ë¢° í˜„í™©</a></li>
							<li class="breadcrumb-item"><a href="#">ë‚´ ì˜ë¢° ìƒì„¸</a></li>
						</ol>
					</div>
				</div>

				<div class="content-title">ë‚´ ì˜ë¢° ìƒì„¸</div>
				<p class="desc">ì ‘ìˆ˜í•œ ì˜ë¢°ì˜ ìƒì„¸ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
			</div>
			<div class="container section">
				<!-- Progress Section -->
				<div class="progress-section">
					<div class="progress-bar-container">
						<div class="progress-bar">
							<c:forEach items="${categoryBar }" var="bar"
								varStatus="categoryStatus">
								<c:set var="currentCategoryName"
									value="${bar.statusCodeMediumCategoryName}" />

								<c:set var="isActive" value="false" />

								<c:forEach items="${contractVo.contractRecordList }"
									var="record" varStatus="recordStatus">
									<c:if
										test="${record.statusCodeMediumCategoryName eq currentCategoryName}">
										<c:set var="isActive" value="true" />
									</c:if>
								</c:forEach>

								<div class="progress-step">
									<button class="step-circle ${isActive ? 'active' : 'inactive'}">
										${categoryStatus.index + 1}</button>
									<span class="step-label">${bar.statusCodeMediumCategoryName}</span>
									<div class="progress-details"
										id="details-step-${categoryStatus.index + 1}"
										style="display: none;">
										<div
											style="color: black; font-size: 12px; margin-left: 60px; width: 300px"
											class="divArea"></div>
									</div>
								</div>
							</c:forEach>
						</div>

					</div>
				</div>

				<!-- Content Section -->
				<div class="content-section">
					
					
					<div class="tabs-container">
						<!-- <div class="tabs-header">
							<div class="tab-button active categories-title" data-tab="detail">
								ìƒì„¸ì •ë³´</div>
							<div class="tab-button categories-title" data-tab="document">
								ì„œë¥˜ê´€ë¦¬</div>
							<div class="tab-button categories-title" data-tab="progress">
								ì§„í–‰ë‚´ì—­</div>
						</div> -->
						<div class="tabs-content-2nd">
						<div class="tabs-content">
							<div class="category-options" id="detail">
								<div class="info-card">
									<div class="info-row">
										<span class="card-title">ì˜ë¢° ì •ë³´</span>
									</div>
									<div class="info-row">
										<span class="info-label">ê³„ì•½ ë²ˆí˜¸</span> <span
											class="info-value">${contractVo.contractNo }</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë“±ë¡ì¼</span> <span class="info-value">${contractVo.contractDate }</span>
									</div>

									<div class="info-row">
										<span class="info-label">ì˜ë¢° ìœ í˜•</span> <span
											class="info-value">${contractVo.contractType }</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆëª…</span> <span class="info-value">${contractVo.productVO.productName }</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆ ì›ì‚°ì§€</span> <span
											class="info-value">${contractVo.productVO.productOrigin }</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆ ìˆ˜ëŸ‰</span> <span
											class="info-value">${contractVo.productVO.productQty }ê°œ</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆ ì¤‘ëŸ‰</span> <span
											class="info-value">${contractVo.productVO.productWeight } KG</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆ ë¶€í”¼</span> <span
											class="info-value">${contractVo.productVO.productVolume} CBM</span>
									</div>
									
									<div class="info-row">
										<span class="info-label">ë¬¼í’ˆ ë‹¨ê°€</span> <span
											class="info-value"><fmt:formatNumber value="${contractVo.productVO.productPrice}" pattern="#,###" /> ì›</span>
									</div>
									
									<c:if test="${contractVo.contractType == 'ìˆ˜ì¶œ' }">
										<c:if test="${contractVo.lastStatusCode == '41'}">
											<div class="info-row">
												<span class="info-label">ì„ ë°• ìœ„ì¹˜<i class="fas fa-ship"></i></span>
												 <button id="shipBtn"><i class="fas fa-eye"></i></button>
											</div>
										</c:if>
									</c:if>
								</div>
								<!-- Manager Information -->
							
								<div class="info-card">
									<div class="info-row">
										<span class="card-title" style="margin-right: 10px">ë‹´ë‹¹ì ì •ë³´</span>
										<button class="" style="border: 1px solid;" id="maskedBtn"><i class="fas fa-eye"></i></button>
									</div>
									<div class="info-row">
										<span class="info-label">ê´€ì„¸ì‚¬</span> <span class="info-value">${contractVo.ccaCompanyName}</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë‹´ë‹¹ì</span>
										<div class="info-value">
											<div style="font-weight: bold; margin-bottom: 10px;"><span id="userName">${contractVo.ccaName }</span></div>
											<div class="contact-info">
												<div class="ccaTel">ğŸ“ ${contractVo.ccaTel }</div>
												<div class="userTel">ğŸ“± <span id="userTel">${contractVo.ccaUserTel } </span></div>
												<div class="ccaUserFax">ğŸ“  ${contractVo.ccaUserFax }</div>
												<div class="ccaUserEmail">âœ‰ï¸ ${contractVo.ccaUserEmail }</div>
											</div>
										</div>
									</div>
											
								<%-- 	<div class="info-row">
										<span class="info-label">ì˜ë¢°ì¸</span> <span class="info-value">${contractVo.consignorCompanyName}</span>
									</div>

									<div class="info-row">
										<span class="info-label">ë‹´ë‹¹ì</span>
										<div class="info-value">
											<div style="font-weight: bold; margin-bottom: 10px;">${contractVo.consignorName }</div>
											<div class="contact-info"
												style="font-weight: bold; margin-bottom: 10px;">
												<div>ğŸ“ ${contractVo.consignorTel }</div>
												<div>ğŸ“± ${contractVo.consignorUserTel }</div>
												<div>ğŸ“  ${contractVo.consignorUserFax }</div>
												<div>âœ‰ï¸ ${contractVo.consignorUserEmail }</div>
											</div>
										</div>
									</div> --%>
									</div>
									<div class="info-card">
										<div class="info-row"> <span class="card-title">ì„œë¥˜</span> </div>
										<div class="section-alert">
				                            <i class="fas fa-exclamation-triangle"></i>
				                            <p>ì„œë¥˜ ìˆ˜ì • ë¶ˆê°€<br>ìˆ˜ì¶œì…ì‹ ê³ ì„œê°€ ì´ë¯¸ ì‘ì„±ë˜ì–´ CI/PL ì„œë¥˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
				                        </div>
				                        <ul class="file-list">
				                            <li class="file-item">
				                                <div class="file-info">
				                                    <i class="fas fa-file-alt"></i>
				                                    <div class="file-details">
				                                        <span class="file-name">ìƒì—…ì†¡ì¥.pdf (CI)</span>
				                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸: 2025-05-10</span>
				                                    </div>
				                                </div>
				                                <div class="file-actions">
				                                    <a href="/pdf/download/ci/${contractVo.ciNo }" class="action-button secondary" id="ciDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
				                                    <button class="btn btn-primary" id="ciBtn" value="${contractVo.ciNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
				                                </div>
				                            </li>
				                            <li class="file-item">
				                                <div class="file-info">
				                                    <i class="fas fa-file-alt"></i>
				                                    <div class="file-details">
				                                        <span class="file-name">íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸.pdf (PL)</span>
				                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸: 2025-05-10</span>
				                                    </div>
				                                </div>
				                                <div class="file-actions">
				                                    <a href="/pdf/download/pl/${contractVo.plNo }" class="action-button secondary" id="plDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
				                                    <button class="btn btn-primary" id="plBtn" value="${contractVo.plNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
				                                </div>
				                            </li>
				                            
		                            <c:set var="getStatusCode" value="${contractVo.lastStatusCode }"/>
									<c:choose>
										<c:when test="${getStatusCode == 2 || getStatusCode == 3 || getStatusCode == 4 || getStatusCode == 5
											|| getStatusCode == 23 || getStatusCode == 24 || getStatusCode == 25 || getStatusCode == 26}">
											ê±°ì ˆë˜ì–´ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°¨ë‹¨ë¡œì§
										</c:when>
										<c:otherwise>
				                            <c:choose>
					                        	<c:when test="${fn:substring(contractVo.contractNo, 0, 3) == 'IMP'}">
					                        		<li class="file-item">
						                                <div class="file-info">
						                                    <i class="fas fa-file-alt"></i>
						                                    <div class="file-details">
						                                        <span class="file-name">í•œê¸€í‘œì‹œì‚¬í•­</span>
						                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸:
							                                        <c:choose>
																		<c:when test="${empty krNotationVO.regDate}">
																	        ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
																	    </c:when>
																	    <c:otherwise>
																	        <fmt:formatDate value="${krNotationVO.regDate}" pattern="yyyy-MM-dd HH:mm:ss" />
																	    </c:otherwise>
																    </c:choose>
																</span>
						                                        
						                                    </div>
						                                </div>
						                                <div class="file-actions">
						                                	<c:choose>
				                                    			<c:when test="${not empty krNotationVO.packagingMaterialKr}">
				                                    				<a href="/pdf/download2.do?url=cca/koreanLabelDetail.do?contractNo=${contractVo.contractNo }" class="action-button secondary" id="knDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
								                                    <button class="btn btn-primary" id="kLabelDetailBtn" value="${contractVo.contractNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
				                                     			</c:when>
																<c:otherwise>
							                                    	<button class="btn btn-warning" id="kLabelWriteBtn" value="${contractVo.contractNo }"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
															    </c:otherwise>
															</c:choose>
						                                </div>
						                            </li>
						                            <li class="file-item">
						                                <div class="file-info">
						                                    <i class="fas fa-file-alt"></i>
						                                    <div class="file-details">
						                                        <span class="file-name">${contractVo.contractType }ì‹ ê³ ì„œ</span>
						                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸: 
						                                        	<c:choose>
																		<c:when test="${empty contractDelNo[0].declDNo}">
																	        ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
																	    </c:when>
																	    <c:otherwise>
																	    	<fmt:parseDate value="${contractDelNo[0].contractFileDate}" var="declDDate" pattern="yyyy-MM-dd" />
																	        <fmt:formatDate value="${declDDate}" pattern="yyyy-MM-dd" />
																	    </c:otherwise>
																    </c:choose>
																</span>
						                                    </div>
						                                </div>
						                                <div class="file-actions">
						                                	<c:choose>
						                                		<c:when test="${empty krNotationVO.packagingMaterialKr}">
								                                    <button class="btn btn-warning" id="" value="${contractDelNo[0].declDNo }"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
				                                     			</c:when>
				                                    			<c:when test="${contractDelNo[0].declDNo != null}">
				                                    				<a href="/pdf/download2.do?url=contract/decl/detail.do?declDNo=${contractDelNo[0].declDNo }"  class="action-button secondary" id="declDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
								                                    <button class="btn btn-primary" id="delDBtn" value="${contractDelNo[0].declDNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
				                                     			</c:when>
																<c:otherwise>
							                                    	<button class="btn btn-warning disable"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
															    </c:otherwise>
															</c:choose>
						                                </div>
						                            </li>
					                        	</c:when>
					                        	<c:otherwise>
					                        		<li class="file-item">
						                                <div class="file-info">
						                                    <i class="fas fa-file-alt"></i>
						                                    <div class="file-details">
						                                        <span class="file-name">${contractVo.contractType }ì‹ ê³ ì„œ</span>
						                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸: 
						                                        	<c:choose>
																		<c:when test="${empty contractDelNo[0].declDNo}">
																	        ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
																	    </c:when>
																	    <c:otherwise>
																	    	<fmt:parseDate value="${contractDelNo[0].contractFileDate}" var="declDDate" pattern="yyyy-MM-dd" />
																	        <fmt:formatDate value="${declDDate}" pattern="yyyy-MM-dd" />
																	    </c:otherwise>
																    </c:choose>
																</span>
						                                    </div>
						                                </div>
						                                <!-- ì‘ì—…ì¤‘ start -->
						                                <div class="file-actions">
						                                	<c:choose>
				                                    			<c:when test="${contractDelNo[0].declDNo != null}">
				                                    				<a href="/pdf/download2.do?url=contract/decl/detail.do?declDNo=${contractDelNo[0].declDNo }"  class="action-button secondary" id="declDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
								                                    <button class="btn btn-primary" id="delDBtn" value="${contractDelNo[0].declDNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
				                                     			</c:when>
																<c:otherwise>
							                                    	<button class="btn btn-warning disable"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
															    </c:otherwise>
															</c:choose>
						                                </div>
						                                <!-- ì‘ì—…ì¤‘ end -->
						                            </li>
					                        	</c:otherwise>
					                        </c:choose>
			                        		
			                        		<c:if test="${contractVo.contractType == 'ìˆ˜ì…'}">
			                        		<li class="file-item">
				                                <div class="file-info">
				                                    <i class="fas fa-file-alt"></i>
				                                    <div class="file-details">
				                                        <span class="file-name">ì„¸ê¸ˆê³ ì§€ì„œ</span>
				                                        
				                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸:
				                                         <c:choose>
															<c:when test="${empty TaxVO.taxDestDate}">
														        ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
														    </c:when>
														    <c:otherwise>
														    	<fmt:parseDate value="${TaxVO.taxDestDate}" var="taxDestDate" pattern="yyyy-MM-dd" />
														        <fmt:formatDate value="${taxDestDate}" pattern="yyyy-MM-dd" />
														    </c:otherwise>
													    </c:choose>
														</span>
				                                    </div>
				                                </div>
				                                <div class="file-actions">
				                                	
				                                	<c:choose>
		                                    			<c:when test="${not empty TaxVO.taxDestDate }">
		                                    				<a href="/pdf/download2.do?url=contract/taxDetail.do?declNo=${declNo }"  class="action-button secondary" id="declDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
						                                    <button class="btn btn-primary" id="taxBtn" value="${contractDelNo[0].declDNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
		                                     			</c:when>
														<c:otherwise>
					                                    	<button class="btn btn-warning" id="" value="${contractVo.contractNo }"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
													    </c:otherwise>
													</c:choose>
				                                </div>
				                            </li>
				                            </c:if>
				                            
				                            <li class="file-item">
				                                <div class="file-info">
				                                    <i class="fas fa-file-alt"></i>
				                                    <div class="file-details">
				                                        <span class="file-name">${contractVo.contractType }ì‹ ê³ í•„ì¦</span>
				                                        <span class="file-meta">ìµœì¢… ì—…ë°ì´íŠ¸: 
				                                        	<c:choose>
																<c:when test="${empty CDVO.cdDate }">
															        ì‘ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
															    </c:when>
															    <c:otherwise>
															    	<fmt:parseDate value="${CDVO.cdDate }" var="cdDate" pattern="yyyy-MM-dd" />
															        <fmt:formatDate value="${cdDate}" pattern="yyyy-MM-dd" />
															    </c:otherwise>
														    </c:choose>
				                                        	
				                                        </span>
				                                    </div>
				                                </div>
				                                <div class="file-actions">
				                                	<c:choose>
		                                    			<c:when test="${not empty CDVO.cdDate }">
		                                    				<a href="/pdf/download2.do?url=servant/cdDetail.do?cdNo=${CDVO.cdNo }"  class="action-button secondary" id="declDlBtn"><i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ</a>
						                                    <button class="btn btn-primary" id="cdBtn" value="${CDVO.cdNo }"><i class="fas fa-edit"></i> ìƒì„¸</button>
		                                     			</c:when>
														<c:otherwise>
					                                    	<button class="btn btn-warning" id="" value="${contractVo.contractNo }"><i class="fas fa-edit"></i> ëŒ€ê¸°ì¤‘</button>
													    </c:otherwise>
													</c:choose>
				                                </div>
				                            </li>
			                            </c:otherwise>
								</c:choose>
				                        </ul>
									</div>
								</div>
							</div>
							
								<div class="tabs-content">
									<div class="info-card">
										<div class="info-row">
											<span class="card-title">ì§„í–‰ ë‚´ì—­</span>
										</div>
										<div>
											<div class="info-row">
												<div class="contract-progress-details">
													<c:forEach items="${contractVo.contractRecordList }"
														var="list" varStatus="status">
														<div style="font-weight: bold;" class="dis-f-ai-c">
															<i class="fas fa-check-circle" style="margin-right: 10px;"></i>
															${list.statusCodeMediumCategoryName } <span style="margin-left: 10px">${list.statusCodeName }</span>
														</div>
														<div style="margin-left: 30px">${list.contractRecordRegDate }</div>
														<c:if test="${! status.last }">
															<i class="fa-solid fa-arrow-down"
																style="margin-left: 60px; margin-bottom: 10px"></i>
														</c:if>
													</c:forEach>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>
<!-- ì„ ë°•ëª¨ë‹¬ -->	
 <div class="modal fade" id="shipMapModal" tabindex="-1" aria-labelledby="shipMapModalLabel">
  <div class="modal-dialog" style="min-width: 1100px;">
    <div class="modal-content" style="min-width: 1100px;">
      <div class="modal-header">
        <h5 class="modal-title" id="shipMapModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="vmap" style="width: 1000px; height: 800px;"></div>
      </div>
    </div>
  </div>
</div> 

	<script>
		$(function() {
			var map = null; 
			var shipMapModal = new bootstrap.Modal(document.getElementById('shipMapModal'));
			
			let listBtn = $("#listBtn");
			let ciBtn = $("#ciBtn");
			let plBtn = $("#plBtn");
			let delDBtn = $("#delDBtn");
			let shipBtn = $("#shipBtn");
			let taxBtn = $("#taxBtn");
			let cdBtn = $("#cdBtn");
			
			let contractNo = window.location.pathname.split("/")[3]
			console.log(contractNo);

			listBtn.on("click", function() {
				location.href = "/consignor/myContract.do";
			})
//-----------------------------------------------------------------------------------------------
	
	/**
	 * VWorld Mapì„ ì´ˆê¸°í™”í•˜ê³  3D ëª¨ë¸ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
	 * @param {number} lon - ê²½ë„
	 * @param {number} lat - ìœ„ë„
	 * @param {string} modelUrl - .gltf ë˜ëŠ” .glb íŒŒì¼ì˜ URL
	 * @param {string} shipName - ì„ ë°• ì´ë¦„
	 */
 	function initMapAndLoadModel(lon, lat, modelUrl, shipName) {
		const uniqueId = `vmap_${Date.now()}`;
	    $('#shipMapModalLabel').text(`${shipName} Location`);

	    // #vmap êµì²´
	    $('#vmap').replaceWith('<div id="vmap" style="width: 1000px; height: 800px;"></div>');

	    // DOM êµì²´ í›„ ë¸Œë¼ìš°ì €ê°€ ë Œë”ë§ì„ ë°˜ì˜í•œ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì‹¤í–‰
	    const options = {
	            mapId: "vmap",
	            initPosition: new vw.CameraPosition(
	                new vw.CoordZ(lon, lat, 500),
	                new vw.Direction(0, -15, 0)
	            ),
	            logo: true,
	            navigation: true
	        };

	        try {
	            map = new vw.Map();
	            map.setOption(options);
	            map.start();

	            // ëª¨ë¸ì€ ì¡°ê¸ˆ ë” ë‚˜ì¤‘ì—
	            setTimeout(() => {
	                loadShipModel(modelUrl, lon, lat);
	            }, 1500);
	        } catch (e) {
	            console.error("ğŸ’¥ map.start() ë‚´ë¶€ ì˜¤ë¥˜:", e);
	            alert("ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	        }

	}


	/**
	 * ì„ ë°• 3D ëª¨ë¸ì„ ì§€ë„ì— ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
	 * @param {string} url - 3D ëª¨ë¸ íŒŒì¼ì˜ URL
	 * @param {number} lon - ê²½ë„
	 * @param {number} lat - ìœ„ë„
	 */
	function loadShipModel(url, lon, lat) {
		if (!url) {
			console.warn("í‘œì‹œí•  3D ëª¨ë¸ì˜ URLì´ ì—†ìŠµë‹ˆë‹¤.");
			return;
		}

		var id = "shipModel_" + new Date().getTime(); // ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ê³ ìœ  ID ìƒì„±
		var point = new vw.CoordZ(lon, lat, 5); // ëª¨ë¸ì„ í‘œì‹œí•  ì¢Œí‘œ (ê³ ë„ëŠ” 1ë¡œ ì„¤ì •)
		
		// ëª¨ë¸ í¬ê¸° ì˜µì…˜ (í•„ìš”ì— ë”°ë¼ ê°’ì„ ì¡°ì ˆ)
		var options = { scale: 1000, minimumPixelSize: 150 };

		var modelz = new vw.geom.ModelZ(id, url, point, options);
		modelz.create();

		// (ì„ íƒ ì‚¬í•­) ëª¨ë¸ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì—¬ íŒì—…ì„ ë„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
		var eventHandler = function(windowPosition, ecefPosition, cartographic, featureInfo) {
			if (featureInfo != null) {
				var html = `<strong>Ship Details</strong><br>ìœ„ë„: ${lat.toFixed(6)}<br>ê²½ë„: ${lon.toFixed(6)}`;
				var title = "ì„ ë°• ì •ë³´";
				// ì´ì „ íŒì—…ì´ ìˆë‹¤ë©´ ì œê±°
				if (map.getPopup("shipPopup")) {
					map.getPopup("shipPopup").destroy();
				}
				var pop = new vw.Popup("shipPopup", "vmap", title, html, 250, 150, windowPosition.x, windowPosition.y);
				pop.create();
			}
		};
		modelz.addEventListener(eventHandler);
	}

	// fetchShipLocation í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
	function fetchShipLocation(shipId, fallbackLat, fallbackLon) {
		return new Promise((resolve, reject) => { // rejectë¥¼ ì¶”ê°€í•˜ì—¬ ì—ëŸ¬ ì²˜ë¦¬
			$.ajax({
				url: "<%=request.getContextPath() %>/logistics/shipLocation.do",
				type: "post",
				dataType: "json",
				data: { shipId: shipId },
				success: function(result) {
					if (result && result.values) {
						resolve({
							lat: parseFloat(result.values.ship_lat),
							lon: parseFloat(result.values.ship_lon)
						});
					} else {
						// ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, fallback ê°’ ì‚¬ìš©
						resolve({ lat: parseFloat(fallbackLat), lon: parseFloat(fallbackLon) });
					}
				},
				error: function(err) {
					console.error("AJAX Error:", err);
					// AJAX ìš”ì²­ ì‹¤íŒ¨ ì‹œ, fallback ê°’ ì‚¬ìš©
					resolve({ lat: parseFloat(fallbackLat), lon: parseFloat(fallbackLon) });
				}
			});
		});
	}
//----------------------------------------------------------------------------------------------------------
	// ëª¨ë‹¬ ë‹«ì„ë•Œ ì´ë²¤íŠ¸
			$('#shipMapModal').on('hidden.bs.modal', function () {
			    location.href = location.href;
			});
//--------------------------------------------------------------------------------------------	
			//
			$(document).ready(function() {
				$(".tab-button").on("click", function() {
					$(".tab-button").removeClass("active");
					$(this).addClass("active");

					$(".tab-pane").removeClass("active");
					var targetTab = $(this).data('tab');
					$('#' + targetTab).addClass('active');

				})
				$('.tab-button.active').click();
			})

			
			//ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹
			let maskedBtn = $("#maskedBtn");
			let userTel = $("#userTel");
			let userName = $("#userName");
			let isMasked = true;
			
			
			function maskPhoneNumber(phoneNumber){
				 if (!phoneNumber || phoneNumber.length < 10) {
			            return phoneNumber; 
			        }
				return phoneNumber.replace(/(\d{3})-?(\d{4})-?(\d{4})/, "$1-****-$3");
			}
			
			function maskName(name){
				 if (!name || name.length < 2) {
			            return name; 
			        }
				 const firstChar = name.charAt(0);
			        const lastChar = name.charAt(name.length - 1);
			        const maskedMiddle = "*".repeat(name.length - 2); // ì¤‘ê°„ ê¸€ì ê°œìˆ˜ë§Œí¼ * ë°˜ë³µ
			        return firstChar + maskedMiddle + lastChar;
			}
		
			const originalPhoneNumber = userTel.text().trim();
			const originalUserName = userName.text().trim();
			
			const maskedPhoneNumber = maskPhoneNumber(originalPhoneNumber);
			const maskedUserName = maskName(originalUserName);
			
			userTel.text(maskedPhoneNumber); //í˜ì´ì§€ ë¡œë”©ì‹œ ë§ˆìŠ¤í‚¹ëœê±° ë³´ì´ê²Œ ã…‡ã…‡
			userName.text(maskedUserName); //í˜ì´ì§€ ë¡œë”©ì‹œ ë§ˆìŠ¤í‚¹ëœê±° ë³´ì´ê²Œ ã…‡ã…‡
			
			maskedBtn.on("click",function(){
				isMasked = !isMasked;
				
				if(isMasked){
					userTel.text(maskedPhoneNumber);
					userName.text(maskedUserName);
				}else{
					userTel.text(originalPhoneNumber);
					userName.text(originalUserName);
				}
			})
			//
		/* 	$(".step-circle").on("click", function() {
				let value = $(this).next(".step-label").text(); //ë²„íŠ¼ì˜ ìˆœì„œ
				let numValue = $(this).text(); //ë²„íŠ¼ì˜ ë²ˆí˜¸
				console.log(value);
				console.log(numValue);
				alert("ì½˜ì†”ì—ëŠ” ê°’ë‚˜ì˜´ ã…‡ã…‡")
				
				let targetDetailsDiv = $("#details-step-" + numValue);
				 $('.progress-details').not(targetDetailsDiv).slideUp();
				 
				 targetDetailsDiv.slideToggle();
				$.ajax({
					url : "/consignor/findStatusCode/" + contractNo,
					type: "get",
					data : {paramName : value},
					success : function(result){
						console.log(result);
						  let specificDivArea = targetDetailsDiv.find(".divArea");
						  
						let html = ``;
						for (let i = 0 ; i < result.length; i++){
							html += `
								<div>
									\${result[i].statusCodeName}										
								</div>
							`;
						}
						
						specificDivArea.html(html);
					}
				})
				
			}) */
			
			ciBtn.on("click",function(){
				let ciNo = ciBtn.val();
				console.log("cií´ë¦­" , ciNo);
				window.open("/ci/detail.do?ciNo="+ciNo
						, "_blank"
						, "width=800,height=1000,scrollbars=yes,resizable=yes");
				//location.href ="/ci/detail.do?ciNo="+ciNo;
			});
			
			plBtn.on("click",function(){
				let plNo = plBtn.val();
				console.log("plí´ë¦­",plNo);
				window.open("/pl/detail.do?plNo="+plNo
						, "_blank"
						, "width=800,height=1000,scrollbars=yes,resizable=yes");
				//location.href ="/pl/detail.do?plNo="+plNo;
			});
			
			delDBtn.on("click",function(){
				let delDNo = delDBtn.val();
				console.log("delDí´ë¦­",delDNo);
				window.open("/contract/decl/detail.do?declDNo="+delDNo
						, "_blank"
						, "width=800,height=1000,scrollbars=yes,resizable=yes");
				//location.href = "/contract/decl/detail.do?declDNo="+delDNo;
			})
		
			let kLabelDetailBtn = $("#kLabelDetailBtn");
			kLabelDetailBtn.on("click",function(){
				let contractNo = kLabelDetailBtn.val();
				window.open("/cca/koreanLabelDetail.do?contractNo="+contractNo
						, "_blank"
						, "width=800,height=1000,scrollbars=yes,resizable=yes");
				//location.href = "/cca/koreanLabelDetail.do?contractNo="+contractNo;
			})
			/** ì„¸ê¸ˆ ê³ ì§€ì„œ ë²„íŠ¼ í´ë¦­**/
			taxBtn.on("click",function(){
				let taxNo = taxBtn.val();
				window.open("/contract/taxDetail.do?declNo="+taxNo,
						"_blank",
				        "width=800,height=1000,scrollbars=yes,resizable=yes");
			})
			
			/**í•„ì¦ë²„íŠ¼**/
			cdBtn.on("click",function(){
				let cdNo = cdBtn.val();
				window.open("/servant/cdDetail.do?cdNo="+cdNo,
						"_blank",
				        "width=800,height=1000,scrollbars=yes,resizable=yes");
			})
			

			let ciDlBtn = $("#ciDlBtn");
			let plDlBtn = $("#plDlBtn");
			let knDlBtn = $("#knDlBtn");
			let declDlBtn = $("#declDlBtn");
			
//-----------------------------------------------------------------------------------------------
			//ì„ ë°•ìœ„ì¹˜ ì¡°íšŒ
    		shipBtn.on("click",async function(event){
    			
    			event.preventDefault();
    			event.stopPropagation();

    			const shipVO = `${shipVO}`;
    			var shipId = `${shipVO.shipId}`;
    			var shipLon = `${shipVO.shipLon}`;
    			var shipLat = `${shipVO.shipLat}`;
    			var shipName = `${shipVO.shipName}`;
    			var ship3dImg = "/ship3dImg/3dModelEx.glb";
    			
    			try {

    				// 1. ìœ„ê²½ë„ ê°’ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    				const { lat, lon } = await fetchShipLocation(shipId, shipLat, shipLon);
    				console.log("ìµœì¢… ì¢Œí‘œ -> ìœ„ë„:", lat, "ê²½ë„:", lon);

    				// 2. Bootstrap ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
    				shipMapModal.show();
    				//shipMapModal
    				// 3. ëª¨ë‹¬ì´ ì™„ì „íˆ í™”ë©´ì— í‘œì‹œëœ í›„('shown.bs.modal' ì´ë²¤íŠ¸) ì§€ë„ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    				//    (divê°€ í™”ë©´ì— ë³´ì—¬ì•¼ VWorldê°€ ì˜¬ë°”ë¥¸ í¬ê¸°ë¡œ ì§€ë„ë¥¼ ë Œë”ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
    				$('#shipMapModal').off('shown.bs.modal').on('shown.bs.modal', function () {
    				    $('#vmap').replaceWith('<div id="vmap" style="width: 100%; height: 600px;"></div>');

    				    // ğŸ” 100ms ì§€ì—° í›„ initMapAndLoadModel ì‹¤í–‰
    				    setTimeout(() => {
    				        initMapAndLoadModel(lon, lat, ship3dImg, shipName);
    				    }, 100);
    				});



    			} catch (err) {
    				console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆì–´ìš”.", err);
    				alert("ì„ ë°• ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    			}
    			
    		});
		
		})
	</script>
</body>
</html>